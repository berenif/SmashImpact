<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Connect - WebRTC Game</title>
  
  <!-- React via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- QR Code Libraries -->
  <script src="vendor/qrcode.js"></script>
  <script src="vendor/jsqr.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #0f1220;
      color: white;
    }
    
    /* Animations */
    @keyframes float1 {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(20px, -10px) rotate(10deg); }
    }
    @keyframes float2 {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(-16px, 14px) rotate(-8deg); }
    }
    @keyframes float3 {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(12px); }
    }
    @keyframes qrFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .orb1 { animation: float1 22s ease-in-out infinite; }
    .orb2 { animation: float2 24s ease-in-out infinite 1s; }
    .orb3 { animation: float3 26s ease-in-out infinite 0.5s; }
    .qr-float { animation: qrFloat 8s ease-in-out infinite; }
    .scanning { animation: pulse 2s ease-in-out infinite; }
    
    @media (prefers-reduced-motion: reduce) {
      .orb1, .orb2, .orb3, .qr-float, .scanning { animation: none; }
    }
    
    /* Custom styles */
    .bg-dark { background-color: #0f1220; }
    .border-light { border-color: rgba(255, 255, 255, 0.1); }
    .bg-surface { background-color: rgba(255, 255, 255, 0.05); }
    .text-muted { color: rgba(255, 255, 255, 0.7); }
    
    /* Video styles */
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 1rem;
    }
    
    .scan-overlay {
      position: absolute;
      inset: 2rem;
      border: 2px solid rgba(255, 255, 255, 0.7);
      border-radius: 0.75rem;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    const { createElement: h, useState, useEffect, useRef } = React;
    const { createRoot } = ReactDOM;

    // WebRTC connection manager
    class WebRTCConnection {
      constructor() {
        this.pc = null;
        this.dc = null;
        this.role = null;
      }

      async createOffer() {
        this.role = 'host';
        this.pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        this.dc = this.pc.createDataChannel('game', { ordered: true });
        
        const offer = await this.pc.createOffer();
        await this.pc.setLocalDescription(offer);
        
        // Wait for ICE gathering
        await new Promise(resolve => {
          if (this.pc.iceGatheringState === 'complete') {
            resolve();
          } else {
            const checkState = () => {
              if (this.pc.iceGatheringState === 'complete') {
                this.pc.removeEventListener('icegatheringstatechange', checkState);
                resolve();
              }
            };
            this.pc.addEventListener('icegatheringstatechange', checkState);
          }
        });

        return btoa(JSON.stringify(this.pc.localDescription));
      }

      async acceptOffer(offerData) {
        this.role = 'player';
        const offer = JSON.parse(atob(offerData));
        
        this.pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        });

        this.pc.ondatachannel = (e) => {
          this.dc = e.channel;
        };

        await this.pc.setRemoteDescription(offer);
        const answer = await this.pc.createAnswer();
        await this.pc.setLocalDescription(answer);

        // Wait for ICE gathering
        await new Promise(resolve => {
          if (this.pc.iceGatheringState === 'complete') {
            resolve();
          } else {
            const checkState = () => {
              if (this.pc.iceGatheringState === 'complete') {
                this.pc.removeEventListener('icegatheringstatechange', checkState);
                resolve();
              }
            };
            this.pc.addEventListener('icegatheringstatechange', checkState);
          }
        });

        return btoa(JSON.stringify(this.pc.localDescription));
      }

      async acceptAnswer(answerData) {
        const answer = JSON.parse(atob(answerData));
        await this.pc.setRemoteDescription(answer);
      }
    }

    // Main App Component
    function P2PConnectMockups() {
      const [tab, setTab] = useState('host');
      const [hostState, setHostState] = useState('waiting');
      const [playerState, setPlayerState] = useState('scanHost');
      const [connectionData, setConnectionData] = useState(null);
      const [scanResult, setScanResult] = useState(null);
      const [webrtc] = useState(() => new WebRTCConnection());
      const bothReady = hostState === 'ready' && playerState === 'ready';

      // Generate offer when showing QR
      useEffect(() => {
        if (hostState === 'showQR' && !connectionData) {
          webrtc.createOffer().then(offer => {
            setConnectionData(offer);
          });
        }
      }, [hostState, connectionData, webrtc]);

      // Handle scan result
      useEffect(() => {
        if (scanResult && tab === 'player') {
          webrtc.acceptOffer(scanResult).then(answer => {
            setConnectionData(answer);
            setPlayerState('ready');
          }).catch(err => {
            console.error('Failed to accept offer:', err);
          });
        } else if (scanResult && tab === 'host') {
          webrtc.acceptAnswer(scanResult).then(() => {
            setHostState('ready');
          }).catch(err => {
            console.error('Failed to accept answer:', err);
          });
        }
      }, [scanResult, tab, webrtc]);

      return h('div', { className: 'min-h-screen text-white bg-dark relative' },
        // Background
        h(AnimatedBackground),
        
        // Header
        h('header', { className: 'relative z-10 border-b border-light' },
          h('div', { className: 'mx-auto max-w-6xl px-4 py-4 flex items-center justify-between' },
            h('div', { className: 'flex items-center gap-3' },
              h('div', { className: 'w-7 h-7 rounded-md bg-surface grid place-items-center font-bold' }, 'P2P'),
              h('span', { className: 'text-sm text-muted' }, 'WebRTC Game Connect')
            ),
            h('nav', { className: 'flex items-center gap-2' },
              h('button', {
                onClick: () => setTab('host'),
                className: `px-3 py-1.5 rounded-xl text-sm border transition ${
                  tab === 'host' ? 'bg-white text-black border-white' : 'bg-surface text-white/80 border-light hover:bg-white/10'
                }`
              }, 'Host'),
              h('button', {
                onClick: () => setTab('player'),
                className: `px-3 py-1.5 rounded-xl text-sm border transition ${
                  tab === 'player' ? 'bg-white text-black border-white' : 'bg-surface text-white/80 border-light hover:bg-white/10'
                }`
              }, 'Player'),
              h('a', {
                href: 'game.html',
                className: 'px-3 py-1.5 rounded-xl text-sm border bg-surface text-white/80 border-light hover:bg-white/10 transition'
              }, '🎮 Full Game'),
              h('a', {
                href: 'menu.html',
                className: 'px-3 py-1.5 rounded-xl text-sm border bg-surface text-white/80 border-light hover:bg-white/10 transition'
              }, '📋 All Demos')
            )
          )
        ),
        
        // Hero section
        h('section', { className: 'relative z-10 mx-auto max-w-6xl px-4 py-8' },
          h('h1', { className: 'text-3xl md:text-4xl font-semibold tracking-tight' }, 
            'WebRTC P2P Connection'),
          h('p', { className: 'mt-2 text-muted max-w-2xl' }, 
            'Connect two browsers directly using QR codes. No server needed after initial connection.')
        ),
        
        // Main content
        h('main', { className: 'relative z-10 mx-auto max-w-6xl px-4 pb-28' },
          tab === 'host' ? 
            h('div', { className: 'grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-6' },
              h(LeftRail, { 
                title: 'Host', 
                subtitle: 'Create a game room',
                onShowQR: () => setHostState('showQR'),
                onScanPlayer: () => setHostState('scanPlayer')
              }),
              h('div', { className: 'space-y-6' },
                h(StatePicker, {
                  label: 'Host state',
                  value: hostState,
                  onChange: setHostState,
                  options: [
                    { value: 'waiting', label: 'Waiting' },
                    { value: 'showQR', label: 'Show QR' },
                    { value: 'scanPlayer', label: 'Scan Answer' },
                    { value: 'ready', label: 'Connected' }
                  ]
                }),
                hostState === 'waiting' && h(HostWaiting),
                hostState === 'showQR' && h(HostShowQR, { data: connectionData }),
                hostState === 'scanPlayer' && h(QRScanner, { 
                  label: 'Scan player answer QR',
                  onScan: setScanResult 
                }),
                hostState === 'ready' && h(HostReady)
              )
            ) :
            h('div', { className: 'grid grid-cols-1 lg:grid-cols-[280px_1fr] gap-6' },
              h(LeftRail, { 
                title: 'Player', 
                subtitle: 'Join a game room',
                onShowQR: () => playerState === 'ready' && setPlayerState('ready'),
                onScanPlayer: () => setPlayerState('scanHost')
              }),
              h('div', { className: 'space-y-6' },
                h(StatePicker, {
                  label: 'Player state',
                  value: playerState,
                  onChange: setPlayerState,
                  options: [
                    { value: 'scanHost', label: 'Scan Host QR' },
                    { value: 'ready', label: 'Connected' }
                  ]
                }),
                playerState === 'scanHost' && h(QRScanner, { 
                  label: 'Scan host QR code to connect',
                  onScan: setScanResult 
                }),
                playerState === 'ready' && h(PlayerReady, { data: connectionData })
              )
            )
        ),
        
        // Footer
        h('footer', { className: 'fixed bottom-0 inset-x-0 bg-black/60 backdrop-blur border-t border-light' },
          h('div', { className: 'mx-auto max-w-6xl px-4 py-3 flex items-center gap-4' },
            h(StepDots, { 
              steps: ['Choose role', 'Exchange QR', 'Connected'],
              activeIndex: bothReady ? 2 : 1
            }),
            h('div', { className: 'ml-auto flex items-center gap-3' },
              h('span', { className: 'text-sm text-muted hidden sm:block' }, 'Connection status'),
              h('span', { 
                className: `px-2 py-1 rounded-md text-xs ${
                  bothReady ? 'bg-emerald-400 text-black' : 'bg-white/10 text-white/80'
                }`
              }, bothReady ? 'P2P Connected' : 'Waiting for connection'),
              h('button', {
                className: `px-4 py-2 rounded-xl text-sm font-medium transition ${
                  bothReady ? 'bg-white text-black hover:bg-white/90' : 'bg-white/10 text-white/60 cursor-not-allowed'
                }`,
                disabled: !bothReady,
                onClick: () => bothReady && (window.location.href = 'game.html')
              }, 'Start Game')
            )
          )
        )
      );
    }

    // QR Scanner Component
    function QRScanner({ label, onScan }) {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [scanning, setScanning] = useState(false);
      const [error, setError] = useState(null);
      const streamRef = useRef(null);

      const startScanning = async () => {
        try {
          setError(null);
          setScanning(true);
          
          // Try different camera constraints for better compatibility
          let stream;
          try {
            stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              } 
            });
          } catch (e) {
            // Fallback to simpler constraints
            stream = await navigator.mediaDevices.getUserMedia({ 
              video: true 
            });
          }
          
          streamRef.current = stream;
          
          // Wait for video element to be ready
          await new Promise((resolve) => {
            const checkVideo = () => {
              if (videoRef.current) {
                videoRef.current.srcObject = stream;
                videoRef.current.onloadedmetadata = () => {
                  videoRef.current.play();
                  resolve();
                };
              } else {
                setTimeout(checkVideo, 100);
              }
            };
            checkVideo();
          });
          
          // Start scanning after video is playing
          setTimeout(() => scanQRCode(), 500);
        } catch (err) {
          setScanning(false);
          let errorMsg = 'Camera access denied. Please allow camera access to scan QR codes.';
          if (err.name === 'NotFoundError') {
            errorMsg = 'No camera found on this device.';
          } else if (err.name === 'NotAllowedError') {
            errorMsg = 'Camera permission denied. Please allow camera access and refresh.';
          } else if (err.name === 'NotReadableError') {
            errorMsg = 'Camera is already in use by another application.';
          }
          setError(errorMsg);
          console.error('Camera error:', err);
        }
      };

      const stopScanning = () => {
        if (streamRef.current) {
          streamRef.current.getTracks().forEach(track => track.stop());
          streamRef.current = null;
        }
        setScanning(false);
      };

      const scanQRCode = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        
        if (!video || !canvas || !streamRef.current) {
          return;
        }

        const ctx = canvas.getContext('2d');

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          try {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            if (typeof jsQR !== 'undefined') {
              const code = jsQR(imageData.data, imageData.width, imageData.height);
              
              if (code && code.data) {
                console.log('QR Code detected:', code.data);
                stopScanning();
                onScan(code.data);
                return;
              }
            }
          } catch (e) {
            console.error('QR scanning error:', e);
          }
        }

        if (scanning) {
          requestAnimationFrame(scanQRCode);
        }
      };

      useEffect(() => {
        return () => stopScanning();
      }, []);

      return h('div', { className: 'rounded-2xl border border-light bg-surface p-4' },
        h('div', { className: 'text-xs uppercase tracking-wider text-white/60 mb-2' }, 'QR Scanner'),
        h('div', { className: 'rounded-2xl border border-light bg-black/30 p-4 min-h-[320px] relative' },
          !scanning ? 
            h('div', { className: 'h-80 grid place-items-center' },
              h('div', { className: 'text-center space-y-4' },
                error && h('p', { className: 'text-red-400 text-sm mb-4' }, error),
                h('button', {
                  onClick: startScanning,
                  className: 'px-6 py-3 bg-white text-black rounded-xl hover:bg-white/90 transition'
                }, '📷 Start Camera'),
                h('p', { className: 'text-sm text-muted mt-2' }, label)
              )
            ) :
            h('div', { className: 'relative h-80 bg-black rounded-xl overflow-hidden' },
              h('video', {
                ref: videoRef,
                autoPlay: true,
                playsInline: true,
                muted: true,
                className: 'w-full h-full object-cover',
                style: { display: 'block' }
              }),
              h('canvas', {
                ref: canvasRef,
                className: 'hidden'
              }),
              h('div', { className: 'scan-overlay scanning' }),
              h('div', { className: 'absolute top-4 left-4 bg-black/50 px-3 py-1 rounded-lg text-xs text-white' },
                '📷 Scanning for QR code...'
              ),
              h('button', {
                onClick: stopScanning,
                className: 'absolute bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition'
              }, 'Stop Scanning')
            )
        )
      );
    }

    // Components
    function AnimatedBackground() {
      return h('div', { className: 'pointer-events-none absolute inset-0 overflow-hidden' },
        h('div', { 
          className: 'orb1 absolute -top-24 -left-24 w-[40vw] h-[40vw] rounded-full blur-3xl',
          style: { background: 'radial-gradient(circle at center, rgba(99,102,241,0.25), rgba(99,102,241,0) 60%)' }
        }),
        h('div', { 
          className: 'orb2 absolute -bottom-24 -right-24 w-[42vw] h-[42vw] rounded-full blur-3xl',
          style: { background: 'radial-gradient(circle at center, rgba(34,211,238,0.22), rgba(34,211,238,0) 60%)' }
        }),
        h('div', { 
          className: 'orb3 absolute top-1/3 left-1/4 w-[28vw] h-[28vw] rounded-full blur-3xl',
          style: { background: 'radial-gradient(circle at center, rgba(236,72,153,0.18), rgba(236,72,153,0) 60%)' }
        })
      );
    }

    function LeftRail({ title, subtitle, onShowQR, onScanPlayer }) {
      return h('aside', { className: 'rounded-2xl border border-light bg-surface p-4' },
        h('div', { className: 'text-xs uppercase tracking-wider text-white/60' }, title),
        h('div', { className: 'mt-1 text-sm text-white/80' }, subtitle),
        h('div', { className: 'mt-4 grid gap-2' },
          h('button', { 
            onClick: onShowQR,
            className: 'h-12 rounded-xl border border-light bg-surface hover:bg-white/10 text-left px-3 transition' 
          },
            h('div', { className: 'text-xs text-white/60' }, 'Step 1'),
            h('div', { className: 'text-sm' }, 'Show QR Code')
          ),
          h('button', { 
            onClick: onScanPlayer,
            className: 'h-12 rounded-xl border border-light bg-surface hover:bg-white/10 text-left px-3 transition' 
          },
            h('div', { className: 'text-xs text-white/60' }, 'Step 2'),
            h('div', { className: 'text-sm' }, 'Scan Response')
          )
        )
      );
    }

    function StatePicker({ label, value, onChange, options }) {
      return h('div', { className: 'flex flex-wrap items-center gap-2' },
        h('span', { className: 'text-sm text-muted mr-1' }, label + ':'),
        ...options.map(o => 
          h('button', {
            key: o.value,
            onClick: () => onChange(o.value),
            className: `px-3 py-1.5 rounded-xl text-sm border transition ${
              value === o.value ? 'bg-white text-black border-white' : 'bg-surface text-white/80 border-light hover:bg-white/10'
            }`
          }, o.label)
        )
      );
    }

    function ScreenCard({ title, children }) {
      return h('div', { className: 'rounded-2xl border border-light bg-surface p-4' },
        h('div', { className: 'text-xs uppercase tracking-wider text-white/60 mb-2' }, title),
        h('div', { className: 'rounded-2xl border border-light bg-black/30 p-4 min-h-[280px] grid place-items-center' },
          children
        )
      );
    }

    function QRCode({ size = 192, data = null }) {
      const canvasRef = useRef(null);
      
      useEffect(() => {
        if (canvasRef.current && data && typeof qrcode !== 'undefined') {
          const canvas = canvasRef.current;
          
          try {
            const qr = qrcode(0, 'L');
            qr.addData(data);
            qr.make();
            
            const count = qr.getModuleCount();
            const scale = Math.floor((size - 16) / count);
            const qrSize = count * scale;
            canvas.width = canvas.height = size - 16;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const margin = Math.floor((canvas.width - qrSize) / 2);
            
            for (let r = 0; r < count; r++) {
              for (let c = 0; c < count; c++) {
                ctx.fillStyle = qr.isDark(r, c) ? '#000' : '#fff';
                ctx.fillRect(margin + c * scale, margin + r * scale, scale, scale);
              }
            }
          } catch (e) {
            console.error('QR generation error:', e);
          }
        }
      }, [size, data]);
      
      return h('div', {
        className: 'bg-white rounded-lg p-2 shadow-inner qr-float',
        style: { width: size, height: size }
      },
        data ? 
          h('canvas', {
            ref: canvasRef,
            width: size - 16,
            height: size - 16,
            style: { display: 'block' }
          }) :
          h('div', { className: 'w-full h-full flex items-center justify-center text-black' },
            h('div', { className: 'text-center' },
              h('div', { className: 'text-2xl mb-2' }, '⏳'),
              h('div', { className: 'text-sm' }, 'Generating...')
            )
          )
      );
    }

    function Pill({ text, muted = false }) {
      return h('div', {
        className: `w-full h-12 rounded-xl border grid place-items-center text-sm ${
          muted ? 'bg-surface text-white/60 border-light' : 'bg-white text-black border-white'
        }`
      }, text);
    }

    function StepDots({ steps, activeIndex }) {
      return h('ol', { className: 'flex items-center gap-3' },
        ...steps.map((s, i) =>
          h('li', { key: s, className: 'flex items-center gap-2' },
            h('span', { className: `w-2.5 h-2.5 rounded-full ${i <= activeIndex ? 'bg-white' : 'bg-white/30'}` }),
            h('span', { className: `text-xs ${i === activeIndex ? 'text-white' : 'text-white/60'}` }, s),
            i < steps.length - 1 && h('span', { className: 'w-6 h-px bg-white/20' })
          )
        )
      );
    }

    // Screen components
    function HostWaiting() {
      return h(ScreenCard, { title: 'Waiting Room' },
        h('div', { className: 'w-full max-w-xl space-y-4' },
          h(Pill, { text: '👤 You (Host)' }),
          h(Pill, { text: '⏳ Waiting for player...', muted: true }),
          h('p', { className: 'text-sm text-muted text-center mt-4' }, 
            'Click "Show QR" to generate a connection code')
        )
      );
    }

    function HostShowQR({ data }) {
      return h('div', { className: 'w-full grid place-items-center gap-4' },
        h(QRCode, { size: 280, data: data }),
        h('div', { className: 'text-center space-y-2' },
          h('div', { className: 'text-sm text-white/80' }, 'Player should scan this code'),
          h('div', { className: 'text-xs text-muted' }, 'Then you scan their response')
        )
      );
    }

    function HostReady() {
      return h(ScreenCard, { title: 'Connected!' },
        h('div', { className: 'w-full max-w-xl space-y-4' },
          h(Pill, { text: '✅ You (Host)' }),
          h(Pill, { text: '✅ Player Connected' }),
          h('p', { className: 'text-sm text-emerald-400 text-center mt-4' }, 
            'WebRTC connection established!')
        )
      );
    }

    function PlayerReady({ data }) {
      return h(ScreenCard, { title: 'Show this to Host' },
        h('div', { className: 'w-full grid place-items-center gap-4' },
          data ? 
            h(QRCode, { size: 280, data: data }) :
            h(Pill, { text: '✅ Connected to host' }),
          h('p', { className: 'text-sm text-emerald-400 text-center' }, 
            'Connection answer generated. Host should scan this.')
        )
      );
    }

    // Initialize app
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('root');
      if (container) {
        try {
          const root = createRoot(container);
          root.render(h(P2PConnectMockups));
        } catch (error) {
          console.error('Failed to render:', error);
          container.innerHTML = '<div style="padding: 20px;">Error loading app. Please refresh.</div>';
        }
      }
    });
  </script>
</body>
</html>