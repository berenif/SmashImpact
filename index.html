<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>P2P LAN Webapp - Playable Tag</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0f1220; color:#e8ecff; display:grid; grid-template-columns: 360px 1fr; height: 100vh; }
    aside { border-right: 1px solid #2a2f4a; padding: 16px; overflow:auto; }
    main { display:grid; grid-template-rows: auto 1fr; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    h2 { font-size: 15px; margin: 16px 0 8px; }
    .box { background:#151936; border:1px solid #2a2f4a; border-radius:12px; padding:12px; }
    textarea, input { width:100%; background:#0f1129; color:#e8ecff; border:1px solid #2a2f4a; border-radius:8px; padding:8px; }
    button { cursor:pointer; border:1px solid #2a2f4a; background:#1a1f3f; color:#e8ecff; border-radius:8px; padding:8px 10px; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display:flex; gap:8px; align-items:center; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .small { font-size: 12px; opacity:.9; }
    canvas { width:100%; height:100%; background:#0b0e1a; display:block; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2a2f4a; background:#121630; font-size:12px; }
    .ok { color:#00d084; }
    .warn { color:#ffc24b; }
    .bad { color:#ff4d4f; }
    .muted { color:#aab2ff; }
    .grid { display:grid; gap:10px; }
    .qr-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
    .qr-modal.show{display:flex}
    .qr-card{background:#151936;border:1px solid #2a2f4a;border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.4)}
    .qr-hint{margin-top:8px}
    .qr-card video{width:360px;max-width:90vw;border-radius:8px;background:#000}
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; border:1px solid #2a2f4a; padding:0 6px; border-radius:6px; background:#101432; font-size:12px; }
    
    /* Cross-browser compatibility improvements */
    * { box-sizing: border-box; }
    
    /* Fallback for browsers that don't support CSS Grid */
    @supports not (display: grid) {
      body { display: flex; }
      aside { flex: 0 0 360px; }
      main { flex: 1; display: flex; flex-direction: column; }
    }
    
    /* Vendor prefixes for better browser support */
    button { 
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    textarea, input { 
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    /* Smooth scrolling for better UX */
    html { scroll-behavior: smooth; }
    
    /* Better focus indicators for accessibility */
    button:focus, textarea:focus, input:focus { 
      outline: 2px solid #4a9eff; 
      outline-offset: 2px;
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .box { border-width: 2px; }
      button { border-width: 2px; }
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
    }
  </style>
</head>
<body>
  <aside>
    <h1>P2P over LAN, pure browser</h1>
    <div class="small muted box" style="margin-bottom:10px">
      Two roles. Host creates an offer, peer pastes it and returns an answer. No server, copy paste or QR only. Same Wiâ€‘Fi is ideal.
    </div>

    <div class="grid">
      <section class="box">
        <h2>1) Host</h2>
        <div class="row" style="margin-bottom:8px">
          <button id="btnHostStart">Create Offer</button>
          <span id="hostState" class="tag">idle</span>
        </div>
        <label class="small">Offer to share</label>
        <textarea id="offerOut" class="mono" rows="6" readonly></textarea>
        <div class="row" style="margin:6px 0 10px">
          <button id="btnCopyOffer" disabled>Copy</button>
          <button id="btnQrOffer" disabled>Show QR</button>
        </div>
        <label class="small">Paste Answer from peer</label>
        <textarea id="answerIn" class="mono" rows="6" placeholder="Paste peer answer JSON here"></textarea>
        <div class="row" style="margin-top:6px">
          <button id="btnApplyAnswer" disabled>Apply Answer</button>
          <button id="btnScanAnswer">Scan QR</button>
        </div>
      </section>

      <section class="box">
        <h2>2) Peer</h2>
        <div class="row" style="margin-bottom:8px">
          <button id="btnPeerStart">Accept Offer</button>
          <span id="peerState" class="tag">idle</span>
        </div>
        <label class="small">Paste Offer from host</label>
        <textarea id="offerIn" class="mono" rows="6" placeholder="Paste host offer JSON here"></textarea>
        <div class="row" style="margin:6px 0 10px">
          <button id="btnApplyOffer" disabled>Apply Offer</button>
          <button id="btnScanOffer">Scan QR</button>
        </div>
        <label class="small">Answer to return</label>
        <textarea id="answerOut" class="mono" rows="6" readonly></textarea>
        <div class="row" style="margin-top:6px">
          <button id="btnCopyAnswer" disabled>Copy</button>
          <button id="btnQrAnswer" disabled>Show QR</button>
        </div>
      </section>

      <section class="box">
        <h2>Status</h2>
        <div class="small mono" id="status">Not connected</div>
        <div class="small mono" id="latency"></div>
      </section>

      <section class="box">
        <h2>Chat, debug</h2>
        <div class="row">
          <input id="chatInput" placeholder="Type a message" />
          <button id="chatSend" disabled>Send</button>
        </div>
        <pre id="log" class="small mono" style="white-space:pre-wrap"></pre>
      </section>

      <section class="box">
        <h2>Diagnostics</h2>
        <div class="row">
          <button id="btnRunTests">Run checks</button>
          <span class="small muted">Quick sanity tests log below</span>
        </div>
      </section>

      <section class="box">
        <h2>How to play</h2>
        <div class="small muted">
          Simple tag. Move with <span class="kbd">WASD</span> or arrows. If you are IT and touch the other player you score and roles swap. First to 10 wins or highest score when the timer ends.
        </div>
      </section>
    </div>
  </aside>

  <main>
    <div class="row" style="padding:10px; gap:16px; align-items:center; border-bottom:1px solid #2a2f4a;">
      <div>Game</div>
      <div class="small muted">You are <span id="meTag" class="tag">not joined</span>, move with WASD or arrows</div>
      <div class="row" style="margin-left:auto; gap:8px">
        <button id="btnStartGame" disabled>Start</button>
        <button id="btnResetGame" disabled>Reset</button>
      </div>
    </div>
    <canvas id="game"></canvas>

    <div id="qrModal" class="qr-modal">
      <div class="qr-card">
        <canvas id="qrCanvas" width="360" height="360"></canvas>
        <div class="row qr-hint" style="justify-content:space-between">
          <span class="small muted">Scan with your camera, copy the text</span>
          <button id="qrClose">Close</button>
        </div>
      </div>
    </div>
    <div id="scanModal" class="qr-modal">
      <div class="qr-card">
        <video id="scanVideo" autoplay playsinline muted></video>
        <div class="row qr-hint" style="justify-content:space-between">
          <span class="small muted">Point at QR. It will auto-fill.</span>
          <button id="scanClose">Close</button>
        </div>
      </div>
    </div>
  </main>

<script src="./vendor/qrcode.js"></script>

<!-- Add QR Scanner library for cross-browser compatibility -->
<script src="./vendor/jsqr.js"></script>

<script>
// Ensure QR library is loaded before proceeding
if (typeof window.qrcode !== 'function') {
  console.error('QR library failed to load');
  // Fallback QR implementation
  window.qrcode = function(typeNumber, errorCorrectLevel) {
    console.warn('Using fallback QR implementation');
    return {
      addData: function(data) { this.data = data; },
      make: function() { this.made = true; },
      getModuleCount: function() { return 21; },
      isDark: function(row, col) { 
        // Simple fallback pattern
        return (row + col) % 2 === 0; 
      }
    };
  };
}

// Cross-browser camera access compatibility
function getMediaDevices() {
  return navigator.mediaDevices || 
         navigator.getUserMedia || 
         navigator.webkitGetUserMedia || 
         navigator.mozGetUserMedia || 
         navigator.msGetUserMedia;
}

function getUserMedia(constraints) {
  const mediaDevices = getMediaDevices();
  
  if (mediaDevices && mediaDevices.getUserMedia) {
    return mediaDevices.getUserMedia(constraints);
  }
  
  // Fallback for older browsers
  if (navigator.getUserMedia) {
    return new Promise((resolve, reject) => {
      navigator.getUserMedia(constraints, resolve, reject);
    });
  }
  
  if (navigator.webkitGetUserMedia) {
    return new Promise((resolve, reject) => {
      navigator.webkitGetUserMedia(constraints, resolve, reject);
    });
  }
  
  if (navigator.mozGetUserMedia) {
    return new Promise((resolve, reject) => {
      navigator.mozGetUserMedia(constraints, resolve, reject);
    });
  }
  
  throw new Error('Camera access not supported in this browser');
}

// Browser compatibility checks and polyfills
function checkBrowserCompatibility() {
  const issues = [];
  
  // Check WebRTC support
  if (!window.RTCPeerConnection && !window.webkitRTCPeerConnection && !window.mozRTCPeerConnection) {
    issues.push('WebRTC not supported - RTCPeerConnection missing');
  }
  
  // Check canvas support
  if (!document.createElement('canvas').getContext) {
    issues.push('Canvas not supported');
  }
  
  // Check for modern JavaScript features
  if (!window.Promise) {
    issues.push('Promises not supported');
  }
  
  // Check for performance.now() with fallback
  if (!window.performance || !window.performance.now) {
    window.performance = window.performance || {};
    window.performance.now = window.performance.now || function() {
      return Date.now();
    };
  }
  
  // Check for requestAnimationFrame with fallback
  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = window.requestAnimationFrame || function(callback) {
      return setTimeout(callback, 1000 / 60);
    };
    window.cancelAnimationFrame = window.cancelAnimationFrame || function(id) {
      clearTimeout(id);
    };
  }
  
  // Check for devicePixelRatio
  if (!window.devicePixelRatio) {
    window.devicePixelRatio = 1;
  }
  
  // Check for camera access
  if (!getMediaDevices()) {
    issues.push('Camera access not supported');
  }
  
  if (issues.length > 0) {
    const warning = document.createElement('div');
    warning.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ff4d4f;color:white;padding:10px;text-align:center;z-index:1000;font-family:system-ui;';
    warning.innerHTML = '<strong>Browser Compatibility Issues:</strong> ' + issues.join(', ');
    document.body.appendChild(warning);
  }
}

// Run compatibility check after DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', checkBrowserCompatibility);
} else {
  checkBrowserCompatibility();
}

// Add error handling for unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', event.reason);
  // Optionally show user-friendly error message
});

// Add error handling for global errors
window.addEventListener('error', function(event) {
  console.error('Global error:', event.error);
});

// Ensure QR library is ready before loading modules
function loadModules() {
  if (typeof window.qrcode === 'function') {
    console.log('QR library ready, loading modules...');
    // Load the main module
    const script = document.createElement('script');
    script.type = 'module';
    script.src = './src/main.js';
    script.onerror = function() {
      console.error('Failed to load main.js module');
    };
    document.head.appendChild(script);
  } else {
    console.warn('QR library not ready, retrying...');
    setTimeout(loadModules, 100);
  }
}

// Start loading modules after a short delay to ensure everything is ready
setTimeout(loadModules, 200);
</script>
</body>
</html>
