<!DOCTYPE html>
<html>
<head>
    <title>Modular WASM Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #status {
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        canvas {
            border: 2px solid #444;
            display: block;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Modular WASM Module Test</h1>
    <div id="status">Loading...</div>
    <canvas id="testCanvas" width="800" height="600"></canvas>
    
    <script type="module">
        const statusDiv = document.getElementById('status');
        const canvas = document.getElementById('testCanvas');
        
        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = message;
            statusDiv.appendChild(p);
            console.log(message);
        }
        
        async function testModules() {
            try {
                log('Testing modular WASM integration...', 'info');
                
                // Test 1: Import modules
                log('1. Importing modules...', 'info');
                const { gameEngine } = await import('./public/game-engine-wrapper.js');
                const { inputHandler } = await import('./public/input-handler.js');
                const { renderer } = await import('./public/renderer.js');
                log('✅ Modules imported successfully', 'success');
                
                // Test 2: Initialize renderer
                log('2. Initializing renderer...', 'info');
                renderer.initialize(canvas);
                log('✅ Renderer initialized', 'success');
                
                // Test 3: Initialize input handler
                log('3. Initializing input handler...', 'info');
                inputHandler.initialize(canvas);
                log('✅ Input handler initialized', 'success');
                
                // Test 4: Initialize game engine with WASM
                log('4. Initializing WASM game engine...', 'info');
                await gameEngine.initialize({
                    width: canvas.width,
                    height: canvas.height
                });
                log('✅ WASM game engine initialized', 'success');
                
                // Test 5: Create entities
                log('5. Creating game entities...', 'info');
                const player = gameEngine.createPlayer(400, 300);
                log(`- Player created: ${JSON.stringify(player)}`, 'info');
                
                gameEngine.createEnemy(200, 200, 100);
                log('- Enemy created', 'info');
                
                gameEngine.createPowerUp(600, 400, 1);
                log('- PowerUp created', 'info');
                
                // Test 6: Update and render
                log('6. Testing update and render...', 'info');
                
                // Update
                gameEngine.update(0.016);
                log('- Update successful', 'info');
                
                // Get entities
                const entities = gameEngine.getAllEntities();
                log(`- Retrieved ${entities.length} entities`, 'info');
                
                // Render
                renderer.render({
                    entities: entities,
                    player: gameEngine.getPlayerState(),
                    showMinimap: true
                });
                log('- Render successful', 'info');
                
                // Test 7: Input handling
                log('7. Testing input handling...', 'info');
                
                // Simulate movement
                inputHandler.setJoystickInput(0.5, -0.5);
                const movement = inputHandler.getMovementInput();
                log(`- Movement input: ${JSON.stringify(movement)}`, 'info');
                
                // Apply to engine
                gameEngine.updatePlayerInput(movement.x, movement.y, 0, 0);
                log('- Player input updated', 'info');
                
                // Test 8: Performance metrics
                log('8. Getting performance metrics...', 'info');
                const metrics = gameEngine.getPerformanceMetrics();
                log(`- Metrics: ${JSON.stringify(metrics)}`, 'info');
                
                log('✅ All tests passed! Modular WASM integration is working correctly.', 'success');
                
                // Run a simple animation loop
                log('Starting animation loop...', 'info');
                let frameCount = 0;
                function animate() {
                    if (frameCount < 60) { // Run for 60 frames
                        gameEngine.update(0.016);
                        const state = {
                            entities: gameEngine.getAllEntities(),
                            player: gameEngine.getPlayerState(),
                            showMinimap: true
                        };
                        renderer.render(state);
                        frameCount++;
                        requestAnimationFrame(animate);
                    } else {
                        log('✅ Animation test complete!', 'success');
                        
                        // Cleanup
                        log('Cleaning up...', 'info');
                        gameEngine.cleanup();
                        inputHandler.cleanup();
                        renderer.cleanup();
                        log('✅ Cleanup complete', 'success');
                    }
                }
                animate();
                
            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // Run the test
        testModules();
    </script>
</body>
</html>