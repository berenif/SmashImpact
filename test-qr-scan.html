<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>QR Code Scanning Test</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: #28a745; background-color: #d4edda; }
        .warning { border-color: #ffc107; background-color: #fff3cd; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        video { width: 100%; max-width: 400px; border: 1px solid #ccc; border-radius: 4px; }
        canvas { border: 1px solid #ccc; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QR Code Scanning Compatibility Test</h1>
        <p>This page tests QR code scanning functionality across different browsers, including Firefox.</p>
        
        <div class="test-section">
            <h3>1. Browser Compatibility Check</h3>
            <button onclick="checkCompatibility()">Run Compatibility Test</button>
            <div id="compatibilityResults"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Camera Access Test</h3>
            <button onclick="testCameraAccess()">Test Camera Access</button>
            <div id="cameraResults"></div>
            <video id="testVideo" autoplay muted playsinline style="display: none;"></video>
        </div>
        
        <div class="test-section">
            <h3>3. QR Code Generation Test</h3>
            <input type="text" id="qrText" value="Test QR Code for Firefox" style="width: 100%; padding: 8px; margin: 10px 0;">
            <button onclick="generateQR()">Generate QR Code</button>
            <canvas id="qrCanvas" width="300" height="300"></canvas>
        </div>
        
        <div class="test-section">
            <h3>4. QR Code Scanning Test</h3>
            <button onclick="startScanning()">Start Scanning</button>
            <button onclick="stopScanning()" disabled id="stopBtn">Stop Scanning</button>
            <div id="scanResults"></div>
            <video id="scanVideo" autoplay muted playsinline></video>
            <canvas id="scanCanvas" style="display: none;"></canvas>
        </div>
        
        <div class="test-section">
            <h3>5. Test Log</h3>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <!-- Load required libraries -->
    <script src="./vendor/qrcode.js"></script>
    <script src="./vendor/jsqr.js"></script>
    
    <script>
        let scanStream = null;
        let scanRunning = false;
        let detector = null;
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007cba';
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // Cross-browser camera access compatibility
        function getMediaDevices() {
            return navigator.mediaDevices || 
                   navigator.getUserMedia || 
                   navigator.webkitGetUserMedia || 
                   navigator.mozGetUserMedia || 
                   navigator.msGetUserMedia;
        }
        
        function getUserMedia(constraints) {
            const mediaDevices = getMediaDevices();
            
            if (mediaDevices && mediaDevices.getUserMedia) {
                return mediaDevices.getUserMedia(constraints);
            }
            
            // Fallback for older browsers
            if (navigator.getUserMedia) {
                return new Promise((resolve, reject) => {
                    navigator.getUserMedia(constraints, resolve, reject);
                });
            }
            
            if (navigator.webkitGetUserMedia) {
                return new Promise((resolve, reject) => {
                    navigator.webkitGetUserMedia(constraints, resolve, reject);
                });
            }
            
            if (navigator.mozGetUserMedia) {
                return new Promise((resolve, reject) => {
                    navigator.mozGetUserMedia(constraints, resolve, reject);
                });
            }
            
            throw new Error('Camera access not supported in this browser');
        }
        
        function checkCompatibility() {
            const results = [];
            
            // Check WebRTC
            if (window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection) {
                results.push('✅ WebRTC supported');
            } else {
                results.push('❌ WebRTC not supported');
            }
            
            // Check Canvas
            if (document.createElement('canvas').getContext) {
                results.push('✅ Canvas supported');
            } else {
                results.push('❌ Canvas not supported');
            }
            
            // Check QR library
            if (typeof window.qrcode === 'function') {
                results.push('✅ QR library loaded');
            } else {
                results.push('❌ QR library not loaded');
            }
            
            // Check jsQR
            if (typeof window.jsQR === 'function') {
                results.push('✅ jsQR fallback available');
            } else {
                results.push('❌ jsQR fallback not available');
            }
            
            // Check BarcodeDetector
            if ('BarcodeDetector' in window) {
                results.push('✅ BarcodeDetector API available');
            } else {
                results.push('⚠️ BarcodeDetector API not available (will use jsQR fallback)');
            }
            
            // Check camera access
            if (getMediaDevices()) {
                results.push('✅ Camera access supported');
            } else {
                results.push('❌ Camera access not supported');
            }
            
            // Check Promises
            if (window.Promise) {
                results.push('✅ Promises supported');
            } else {
                results.push('❌ Promises not supported');
            }
            
            // Check performance.now
            if (window.performance && window.performance.now) {
                results.push('✅ performance.now supported');
            } else {
                results.push('❌ performance.now not supported');
            }
            
            // Check requestAnimationFrame
            if (window.requestAnimationFrame) {
                results.push('✅ requestAnimationFrame supported');
            } else {
                results.push('❌ requestAnimationFrame not supported');
            }
            
            const resultsHtml = results.map(r => `<div>${r}</div>`).join('');
            document.getElementById('compatibilityResults').innerHTML = resultsHtml;
            
            log('Compatibility check completed');
            results.forEach(result => console.log(result));
        }
        
        async function testCameraAccess() {
            try {
                log('Testing camera access...');
                showResult('cameraResults', 'Testing camera access...', 'warning');
                
                const stream = await getUserMedia({ video: true, audio: false });
                const video = document.getElementById('testVideo');
                video.srcObject = stream;
                video.style.display = 'block';
                
                showResult('cameraResults', 'Camera access successful!', 'success');
                log('Camera access test passed', 'success');
                
                // Stop the test stream after 5 seconds
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    log('Test camera stream stopped');
                }, 5000);
                
            } catch (error) {
                showResult('cameraResults', `Camera access failed: ${error.message}`, 'error');
                log(`Camera access test failed: ${error.message}`, 'error');
            }
        }
        
        function generateQR() {
            try {
                const text = document.getElementById('qrText').value;
                if (!text) {
                    log('Please enter some text', 'error');
                    return;
                }
                
                if (typeof window.qrcode !== 'function') {
                    log('QR library not loaded', 'error');
                    return;
                }
                
                const canvas = document.getElementById('qrCanvas');
                const ctx = canvas.getContext('2d');
                
                // Generate QR code
                const qr = window.qrcode(0, 'L');
                qr.addData(text);
                qr.make();
                
                const count = qr.getModuleCount();
                const scale = 8;
                const size = count * scale;
                
                canvas.width = canvas.height = Math.max(300, size);
                
                // Clear canvas
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const offset = Math.floor((canvas.width - size) / 2);
                
                // Draw QR code
                for (let r = 0; r < count; r++) {
                    for (let c = 0; c < count; c++) {
                        ctx.fillStyle = qr.isDark(r, c) ? '#000' : '#fff';
                        ctx.fillRect(offset + c * scale, offset + r * scale, scale, scale);
                    }
                }
                
                log('QR code generated successfully!', 'success');
                
            } catch (error) {
                log(`Error generating QR code: ${error.message}`, 'error');
            }
        }
        
        async function startScanning() {
            try {
                log('Starting QR scanning...');
                showResult('scanResults', 'Starting QR scanning...', 'warning');
                
                // Check if we're on a secure origin
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    throw new Error('Camera requires HTTPS or localhost');
                }
                
                // Try modern BarcodeDetector first, then fallback to jsQR
                let useBarcodeDetector = false;
                if ('BarcodeDetector' in window) {
                    try {
                        detector = new BarcodeDetector({ formats: ['qr_code'] });
                        useBarcodeDetector = true;
                        log('Using BarcodeDetector API');
                    } catch (e) {
                        log('BarcodeDetector failed, using jsQR fallback', 'warning');
                    }
                } else {
                    log('BarcodeDetector not available, using jsQR fallback', 'warning');
                }
                
                // Start camera
                scanStream = await getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                const video = document.getElementById('scanVideo');
                video.srcObject = scanStream;
                await video.play();
                
                scanRunning = true;
                document.getElementById('stopBtn').disabled = false;
                
                showResult('scanResults', 'Scanning for QR codes...', 'warning');
                log('QR scanning started');
                
                // Start detection loop
                const loop = async () => {
                    if (!scanRunning) return;
                    
                    try {
                        let raw = '';
                        
                        if (useBarcodeDetector && detector) {
                            // Use modern BarcodeDetector
                            const codes = await detector.detect(video);
                            if (codes && codes.length) {
                                raw = codes[0].rawValue || '';
                            }
                        } else {
                            // Use jsQR fallback for Firefox and other browsers
                            const canvas = document.getElementById('scanCanvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            if (window.jsQR) {
                                const code = window.jsQR(imageData.data, imageData.width, imageData.height);
                                if (code) {
                                    raw = code.data;
                                }
                            }
                        }
                        
                        if (raw) {
                            showResult('scanResults', `QR Code detected: ${raw}`, 'success');
                            log(`QR Code detected: ${raw}`, 'success');
                            stopScanning();
                            return;
                        }
                    } catch (err) {
                        console.warn('QR detection error:', err);
                    }
                    
                    requestAnimationFrame(loop);
                };
                
                requestAnimationFrame(loop);
                
            } catch (error) {
                showResult('scanResults', `Scanning failed: ${error.message}`, 'error');
                log(`QR scanning failed: ${error.message}`, 'error');
                stopScanning();
            }
        }
        
        function stopScanning() {
            scanRunning = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            
            showResult('scanResults', 'Scanning stopped', 'info');
            log('QR scanning stopped');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('QR Scanning Test Page Loaded');
            log('Browser: ' + navigator.userAgent);
            
            // Auto-run compatibility check
            setTimeout(checkCompatibility, 500);
        });
    </script>
</body>
</html>