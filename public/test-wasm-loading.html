<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Loading Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #0f0;
        }
        .error {
            color: #f00;
            border-color: #f00;
        }
        .warn {
            color: #ff0;
            border-color: #ff0;
        }
        .success {
            color: #0f0;
            border-color: #0f0;
        }
    </style>
</head>
<body>
    <h1>WASM Module Loading Test</h1>
    <div id="logs"></div>
    
    <!-- Load the WASM module -->
    <script src="game_engine.js"></script>
    
    <script>
        const logsDiv = document.getElementById('logs');
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(div);
            console[type === 'error' ? 'error' : type === 'warn' ? 'warn' : 'log'](message);
        }
        
        async function testWASMLoading() {
            log('Starting WASM loading test...');
            
            // Test 1: Check if createGameEngine exists
            if (typeof createGameEngine === 'undefined') {
                log('❌ createGameEngine is not defined', 'error');
                log('Check if game_engine.js loaded correctly', 'error');
                return;
            }
            log('✓ createGameEngine function found', 'success');
            
            // Test 2: Check the type of createGameEngine
            log(`createGameEngine type: ${typeof createGameEngine}`);
            
            // Test 3: Try to call createGameEngine
            try {
                log('Attempting to initialize WASM module...');
                const startTime = performance.now();
                
                const Module = await createGameEngine();
                
                const loadTime = (performance.now() - startTime).toFixed(2);
                log(`✓ WASM module loaded successfully in ${loadTime}ms`, 'success');
                
                // Test 4: Check what's in the module
                log('Module properties:', 'success');
                const props = Object.keys(Module).filter(key => typeof Module[key] === 'function');
                props.forEach(prop => {
                    log(`  - ${prop}()`, 'success');
                });
                
                // Test 5: Try to create a GameEngine if available
                if (Module.GameEngine) {
                    try {
                        log('Attempting to create GameEngine instance...');
                        const engine = new Module.GameEngine(800, 600);
                        log('✓ GameEngine instance created successfully', 'success');
                        
                        // Test some methods if available
                        if (engine.update) {
                            engine.update(16);
                            log('✓ engine.update() called successfully', 'success');
                        }
                        
                        if (engine.render) {
                            // Create a test canvas
                            const canvas = document.createElement('canvas');
                            canvas.width = 800;
                            canvas.height = 600;
                            const ctx = canvas.getContext('2d');
                            // Note: This might not work if render expects different parameters
                            log('✓ engine.render() method exists', 'success');
                        }
                        
                        // Clean up
                        if (engine.delete) {
                            engine.delete();
                            log('✓ GameEngine instance cleaned up', 'success');
                        }
                    } catch (error) {
                        log(`Failed to create GameEngine: ${error.message}`, 'warn');
                        log('This might be normal if GameEngine requires different parameters', 'warn');
                    }
                } else {
                    log('GameEngine class not found in module', 'warn');
                    log('Available classes:', 'warn');
                    Object.keys(Module).forEach(key => {
                        if (typeof Module[key] === 'function' && key[0] === key[0].toUpperCase()) {
                            log(`  - ${key}`, 'warn');
                        }
                    });
                }
                
                // Store globally for debugging
                window.wasmModule = Module;
                log('Module stored in window.wasmModule for debugging', 'success');
                
            } catch (error) {
                log(`❌ Failed to load WASM module: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
            }
        }
        
        // Wait for page to fully load
        window.addEventListener('load', () => {
            log('Page loaded, starting tests...');
            testWASMLoading();
        });
        
        // Also try immediately in case script is already loaded
        if (document.readyState === 'complete') {
            log('Page already loaded, starting tests immediately...');
            testWASMLoading();
        }
    </script>
</body>
</html>