<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAssembly Game Engine Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #performance {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .metric {
            margin: 5px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>WebAssembly Game Engine Test</h1>
    <div>
        <button onclick="runBenchmark()">Run Benchmark</button>
        <button onclick="startStressTest()">Start Stress Test</button>
        <button onclick="stopTest()">Stop Test</button>
    </div>
    <div id="performance">
        <h3>Performance Metrics</h3>
        <div class="metric">Physics Time: <span id="physicsTime">-</span> ms</div>
        <div class="metric">Collision Time: <span id="collisionTime">-</span> ms</div>
        <div class="metric">Collision Checks: <span id="collisionChecks">-</span></div>
        <div class="metric">Active Entities: <span id="entityCount">-</span></div>
        <div class="metric">FPS: <span id="fps">-</span></div>
    </div>
    <div id="output"></div>

    <script type="module">
        import GameEngineModule from './game_engine.js';
        
        let engine = null;
        let testInterval = null;
        let lastTime = performance.now();
        let frameCount = 0;
        
        // Initialize the WebAssembly module
        GameEngineModule().then(Module => {
            window.Module = Module;
            console.log('WebAssembly module loaded successfully!');
            
            // Create game engine instance
            engine = new Module.GameEngine(1600, 1000);
            window.engine = engine;
            
            // Create player
            const playerId = engine.createPlayer(800, 500);
            console.log('Player created with ID:', playerId);
            
            // Create some initial enemies
            for (let i = 0; i < 5; i++) {
                engine.createEnemy(
                    Math.random() * 1600,
                    Math.random() * 1000,
                    2 + Math.random() * 3
                );
            }
            
            console.log('Engine initialized with test entities');
        }).catch(err => {
            console.error('Failed to load WebAssembly module:', err);
        });
        
        window.runBenchmark = function() {
            if (!engine) {
                alert('Engine not loaded yet!');
                return;
            }
            
            console.log('Running benchmark...');
            const output = document.getElementById('output');
            output.innerHTML = '<h3>Benchmark Results</h3>';
            
            // Test with different entity counts
            const entityCounts = [10, 50, 100, 200, 500];
            const results = [];
            
            for (const count of entityCounts) {
                // Clear existing entities
                const positions = engine.getEntityPositions();
                for (let i = 0; i < positions.length; i++) {
                    const entity = positions[i];
                    if (entity.type !== 0) { // Not player
                        engine.removeEntity(entity.id);
                    }
                }
                
                // Create test entities
                for (let i = 0; i < count; i++) {
                    engine.createEnemy(
                        Math.random() * 1600,
                        Math.random() * 1000,
                        2 + Math.random() * 3
                    );
                }
                
                // Run update loop and measure performance
                const startTime = performance.now();
                for (let frame = 0; frame < 100; frame++) {
                    engine.update(16.67); // 60 FPS
                }
                const endTime = performance.now();
                const avgTime = (endTime - startTime) / 100;
                
                const metrics = engine.getPerformanceMetrics();
                results.push({
                    entities: count,
                    avgFrameTime: avgTime.toFixed(2),
                    physicsTime: metrics.physicsTime.toFixed(2),
                    collisionTime: metrics.collisionTime.toFixed(2),
                    collisionChecks: metrics.collisionChecks
                });
                
                output.innerHTML += `
                    <div>
                        <strong>${count} entities:</strong> 
                        ${avgTime.toFixed(2)}ms avg, 
                        ${(1000/avgTime).toFixed(0)} FPS potential
                    </div>
                `;
            }
            
            console.table(results);
        };
        
        window.startStressTest = function() {
            if (!engine) {
                alert('Engine not loaded yet!');
                return;
            }
            
            if (testInterval) {
                clearInterval(testInterval);
            }
            
            console.log('Starting stress test...');
            
            // Add many entities
            for (let i = 0; i < 100; i++) {
                engine.createEnemy(
                    Math.random() * 1600,
                    Math.random() * 1000,
                    2 + Math.random() * 3
                );
            }
            
            // Start update loop
            testInterval = setInterval(() => {
                const deltaTime = 16.67; // 60 FPS target
                
                // Simulate player input
                const time = performance.now() / 1000;
                const dx = Math.sin(time) * 0.5;
                const dy = Math.cos(time) * 0.5;
                engine.updatePlayerInput(dx, dy, deltaTime);
                
                // Update engine
                engine.update(deltaTime);
                
                // Update metrics display
                const metrics = engine.getPerformanceMetrics();
                document.getElementById('physicsTime').textContent = metrics.physicsTime.toFixed(2);
                document.getElementById('collisionTime').textContent = metrics.collisionTime.toFixed(2);
                document.getElementById('collisionChecks').textContent = metrics.collisionChecks;
                document.getElementById('entityCount').textContent = metrics.activeEntities;
                
                // Calculate FPS
                frameCount++;
                const now = performance.now();
                if (now - lastTime > 1000) {
                    document.getElementById('fps').textContent = frameCount;
                    frameCount = 0;
                    lastTime = now;
                }
                
                // Randomly spawn new enemies
                if (Math.random() < 0.05 && metrics.activeEntities < 500) {
                    engine.createEnemy(
                        Math.random() * 1600,
                        Math.random() * 1000,
                        2 + Math.random() * 3
                    );
                }
            }, 16);
        };
        
        window.stopTest = function() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
                console.log('Test stopped');
            }
        };
    </script>
</body>
</html>
