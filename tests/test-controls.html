<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }
    
    #testArea {
      width: 400px;
      height: 400px;
      border: 2px solid #444;
      position: relative;
      margin: 20px auto;
      background: #222;
    }
    
    #player {
      width: 20px;
      height: 20px;
      background: #22d3ee;
      border-radius: 50%;
      position: absolute;
      transform: translate(-50%, -50%);
      transition: none;
    }
    
    #stats {
      text-align: center;
      margin: 20px;
    }
    
    .stat {
      display: inline-block;
      margin: 0 10px;
      padding: 5px 10px;
      background: #333;
      border-radius: 5px;
    }
    
    #mobileControls {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      display: none;
    }
    
    .joystick-area {
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      position: relative;
      margin: 0 auto;
    }
    
    .joystick-knob {
      width: 40px;
      height: 40px;
      background: rgba(34,211,238,0.8);
      border: 2px solid #22d3ee;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    @media (max-width: 768px) {
      #mobileControls {
        display: block;
      }
    }
  </style>
</head>
<body>
  <h1 style="text-align: center;">Control Test</h1>
  
  <div id="testArea">
    <div id="player"></div>
  </div>
  
  <div id="stats">
    <div class="stat">X: <span id="xPos">200</span></div>
    <div class="stat">Y: <span id="yPos">200</span></div>
    <div class="stat">Speed: <span id="speed">0</span></div>
    <div class="stat">Input: <span id="input">0, 0</span></div>
    <div class="stat">Platform: <span id="platform">-</span></div>
  </div>
  
  <div id="mobileControls">
    <div class="joystick-area" id="joystick">
      <div class="joystick-knob" id="joystickKnob"></div>
    </div>
  </div>
  
  <script type="module">
    import { ControlConfig } from '../src/game/control-config.js';
    
    class ControlTest {
      constructor() {
        this.player = {
          x: 200,
          y: 200,
          vx: 0,
          vy: 0
        };
        
        this.input = { x: 0, y: 0 };
        this.keys = {};
        this.keyboardInput = { x: 0, y: 0 };
        this.isMobile = 'ontouchstart' in window;
        
        this.init();
        this.animate();
      }
      
      init() {
        // Display platform
        document.getElementById('platform').textContent = this.isMobile ? 'Mobile' : 'Desktop';
        
        if (this.isMobile) {
          this.initMobileControls();
        } else {
          this.initDesktopControls();
        }
      }
      
      initDesktopControls() {
        window.addEventListener('keydown', (e) => {
          this.keys[e.key.toLowerCase()] = true;
        });
        
        window.addEventListener('keyup', (e) => {
          this.keys[e.key.toLowerCase()] = false;
        });
      }
      
      initMobileControls() {
        const joystick = document.getElementById('joystick');
        const knob = document.getElementById('joystickKnob');
        
        let active = false;
        let startPos = { x: 0, y: 0 };
        
        const handleStart = (e) => {
          e.preventDefault();
          active = true;
          const touch = e.touches[0];
          const rect = joystick.getBoundingClientRect();
          startPos = {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2
          };
          updatePosition(touch.clientX, touch.clientY);
        };
        
        const handleMove = (e) => {
          if (!active) return;
          e.preventDefault();
          const touch = e.touches[0];
          updatePosition(touch.clientX, touch.clientY);
        };
        
        const handleEnd = (e) => {
          e.preventDefault();
          active = false;
          knob.style.transform = 'translate(-50%, -50%)';
          this.input = { x: 0, y: 0 };
        };
        
        const updatePosition = (x, y) => {
          const deltaX = x - startPos.x;
          const deltaY = y - startPos.y;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          const maxDistance = 40;
          
          let knobX, knobY;
          if (distance <= maxDistance) {
            knobX = deltaX;
            knobY = deltaY;
          } else {
            const angle = Math.atan2(deltaY, deltaX);
            knobX = Math.cos(angle) * maxDistance;
            knobY = Math.sin(angle) * maxDistance;
          }
          
          knob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;
          
          // Apply dead zone
          const rawInput = {
            x: knobX / maxDistance,
            y: knobY / maxDistance
          };
          
          this.input = ControlConfig.applyDeadZone(rawInput.x, rawInput.y);
        };
        
        joystick.addEventListener('touchstart', handleStart);
        joystick.addEventListener('touchmove', handleMove);
        joystick.addEventListener('touchend', handleEnd);
      }
      
      update(deltaTime) {
        // Get input
        if (this.isMobile) {
          // Mobile uses joystick input directly
        } else {
          // Desktop keyboard input
          const targetX = ((this.keys['a'] || this.keys['arrowleft']) ? -1 : 0) + 
                         ((this.keys['d'] || this.keys['arrowright']) ? 1 : 0);
          const targetY = ((this.keys['w'] || this.keys['arrowup']) ? -1 : 0) + 
                         ((this.keys['s'] || this.keys['arrowdown']) ? 1 : 0);
          
          // Smooth keyboard input
          this.keyboardInput.x = ControlConfig.smoothInput(this.keyboardInput.x, targetX);
          this.keyboardInput.y = ControlConfig.smoothInput(this.keyboardInput.y, targetY);
          
          // Normalize diagonal movement
          const magnitude = Math.sqrt(this.keyboardInput.x ** 2 + this.keyboardInput.y ** 2);
          if (magnitude > 1) {
            this.input.x = this.keyboardInput.x / magnitude;
            this.input.y = this.keyboardInput.y / magnitude;
          } else {
            this.input.x = this.keyboardInput.x;
            this.input.y = this.keyboardInput.y;
          }
        }
        
        // Apply movement
        const boost = this.keys && this.keys['shift'];
        const speed = ControlConfig.getSpeed(boost, this.isMobile ? 'mobile' : 'desktop');
        
        this.player.vx = ControlConfig.smoothInput(this.player.vx, this.input.x * speed);
        this.player.vy = ControlConfig.smoothInput(this.player.vy, this.input.y * speed);
        
        this.player.x += this.player.vx * (deltaTime / 1000) * 60; // 60 fps base
        this.player.y += this.player.vy * (deltaTime / 1000) * 60;
        
        // Keep in bounds
        this.player.x = Math.max(10, Math.min(390, this.player.x));
        this.player.y = Math.max(10, Math.min(390, this.player.y));
        
        // Update display
        this.updateDisplay();
      }
      
      updateDisplay() {
        const playerEl = document.getElementById('player');
        playerEl.style.left = this.player.x + 'px';
        playerEl.style.top = this.player.y + 'px';
        
        document.getElementById('xPos').textContent = Math.round(this.player.x);
        document.getElementById('yPos').textContent = Math.round(this.player.y);
        document.getElementById('speed').textContent = 
          Math.round(Math.sqrt(this.player.vx ** 2 + this.player.vy ** 2) * 10) / 10;
        document.getElementById('input').textContent = 
          `${this.input.x.toFixed(2)}, ${this.input.y.toFixed(2)}`;
      }
      
      animate() {
        let lastTime = 0;
        const loop = (currentTime) => {
          const deltaTime = currentTime - lastTime;
          lastTime = currentTime;
          
          if (deltaTime < 100) { // Cap delta time
            this.update(deltaTime);
          }
          
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
      }
    }
    
    new ControlTest();
  </script>
</body>
</html>