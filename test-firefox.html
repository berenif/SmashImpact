<!DOCTYPE html>
<html>
<head>
    <title>Firefox QR Code Compatibility Test</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        canvas { 
            border: 1px solid #ccc; 
            margin: 20px 0; 
            background: white;
        }
        button { 
            padding: 10px 20px; 
            margin: 10px; 
            background: #0066cc; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        button:hover { background: #0052a3; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .browser-info { 
            background: #e2e3e5; 
            color: #383d41; 
            border: 1px solid #d6d8db; 
            padding: 15px; 
            border-radius: 4px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .qr-display {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Firefox QR Code Compatibility Test</h1>
    
    <div class="browser-info">
        <h3>Browser Information</h3>
        <div id="browserInfo"></div>
    </div>

    <div class="test-section">
        <h3>1. Basic QR Library Test</h3>
        <button onclick="testQRLibrary()">Test QR Library Loading</button>
        <div id="libraryStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h3>2. QR Code Generation Test</h3>
        <button onclick="testQRGeneration()">Generate Test QR Code</button>
        <div class="test-grid">
            <div class="qr-display">
                <h4>Simple Text QR</h4>
                <canvas id="qrCanvas1" width="300" height="300"></canvas>
                <div id="qrStatus1" class="status"></div>
            </div>
            <div class="qr-display">
                <h4>Complex Data QR</h4>
                <canvas id="qrCanvas2" width="300" height="300"></canvas>
                <div id="qrStatus2" class="status"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>3. Canvas Compatibility Test</h3>
        <button onclick="testCanvasCompatibility()">Test Canvas Operations</button>
        <div id="canvasStatus" class="status"></div>
        <canvas id="testCanvas" width="200" height="200"></canvas>
    </div>

    <div class="test-section">
        <h3>4. Error Handling Test</h3>
        <button onclick="testErrorHandling()">Test Error Handling</button>
        <div id="errorStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h3>5. Performance Test</h3>
        <button onclick="testPerformance()">Test QR Generation Performance</button>
        <div id="performanceStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h3>6. Firefox-Specific Tests</h3>
        <button onclick="testFirefoxSpecific()">Run Firefox Tests</button>
        <div id="firefoxStatus" class="status"></div>
    </div>

    <script src="./vendor/qrcode.js"></script>
    <script>
        // Browser detection
        function getBrowserInfo() {
            const userAgent = navigator.userAgent;
            const browserInfo = document.getElementById('browserInfo');
            
            let browser = 'Unknown';
            let version = 'Unknown';
            
            if (userAgent.includes('Firefox')) {
                browser = 'Firefox';
                const match = userAgent.match(/Firefox\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
            } else if (userAgent.includes('Chrome')) {
                browser = 'Chrome';
                const match = userAgent.match(/Chrome\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
            } else if (userAgent.includes('Safari')) {
                browser = 'Safari';
                const match = userAgent.match(/Version\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
            } else if (userAgent.includes('Edge')) {
                browser = 'Edge';
                const match = userAgent.match(/Edge\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
            }
            
            browserInfo.innerHTML = `
                <strong>Browser:</strong> ${browser} ${version}<br>
                <strong>User Agent:</strong> ${userAgent}<br>
                <strong>Platform:</strong> ${navigator.platform}<br>
                <strong>Language:</strong> ${navigator.language}<br>
                <strong>Cookies Enabled:</strong> ${navigator.cookieEnabled}<br>
                <strong>Online:</strong> ${navigator.onLine}
            `;
            
            return { browser, version };
        }

        // Test 1: QR Library Loading
        function testQRLibrary() {
            const status = document.getElementById('libraryStatus');
            
            try {
                if (typeof window.qrcode !== 'function') {
                    status.textContent = '❌ QR library not loaded';
                    status.className = 'status error';
                    return;
                }
                
                // Test basic functionality
                const qr = window.qrcode(1, 'L');
                if (!qr || typeof qr.addData !== 'function') {
                    status.textContent = '❌ QR library loaded but methods missing';
                    status.className = 'status error';
                    return;
                }
                
                status.textContent = '✅ QR library loaded successfully with all methods';
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '❌ Error testing QR library: ' + error.message;
                status.className = 'status error';
                console.error('QR library test error:', error);
            }
        }

        // Test 2: QR Code Generation
        function testQRGeneration() {
            testSimpleQR();
            testComplexQR();
        }

        function testSimpleQR() {
            const canvas = document.getElementById('qrCanvas1');
            const status = document.getElementById('qrStatus1');
            
            try {
                const qr = window.qrcode(1, 'L');
                qr.addData('Hello Firefox!');
                qr.make();
                
                const count = qr.getModuleCount();
                const scale = 8;
                const size = count * scale;
                
                canvas.width = canvas.height = Math.max(300, size);
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const offset = Math.floor((canvas.width - size) / 2);
                
                // Draw QR code
                for (let r = 0; r < count; r++) {
                    for (let c = 0; c < count; c++) {
                        ctx.fillStyle = qr.isDark(r, c) ? '#000' : '#fff';
                        ctx.fillRect(offset + c * scale, offset + r * scale, scale, scale);
                    }
                }
                
                status.textContent = '✅ Simple QR generated successfully';
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '❌ Error: ' + error.message;
                status.className = 'status error';
                console.error('Simple QR error:', error);
            }
        }

        function testComplexQR() {
            const canvas = document.getElementById('qrCanvas2');
            const status = document.getElementById('qrStatus2');
            
            try {
                const complexData = JSON.stringify({
                    type: 'test',
                    timestamp: Date.now(),
                    data: 'Complex test data with special chars: éñü@#$%^&*()',
                    nested: { level1: { level2: 'deep' } }
                });
                
                const qr = window.qrcode(1, 'L');
                qr.addData(complexData);
                qr.make();
                
                const count = qr.getModuleCount();
                const scale = 8;
                const size = count * scale;
                
                canvas.width = canvas.height = Math.max(300, size);
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const offset = Math.floor((canvas.width - size) / 2);
                
                // Draw QR code
                for (let r = 0; r < count; r++) {
                    for (let c = 0; c < count; c++) {
                        ctx.fillStyle = qr.isDark(r, c) ? '#000' : '#fff';
                        ctx.fillRect(offset + c * scale, offset + r * scale, scale, scale);
                    }
                }
                
                status.textContent = '✅ Complex QR generated successfully';
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '❌ Error: ' + error.message;
                status.className = 'status error';
                console.error('Complex QR error:', error);
            }
        }

        // Test 3: Canvas Compatibility
        function testCanvasCompatibility() {
            const status = document.getElementById('canvasStatus');
            const canvas = document.getElementById('testCanvas');
            
            try {
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    status.textContent = '❌ Canvas 2D context not available';
                    status.className = 'status error';
                    return;
                }
                
                // Test basic canvas operations
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(0, 0, 100, 100);
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(100, 100, 100, 100);
                
                ctx.strokeStyle = '#0000ff';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(200, 200);
                ctx.stroke();
                
                // Test text rendering
                ctx.fillStyle = '#000';
                ctx.font = '20px Arial';
                ctx.fillText('Canvas Test', 50, 150);
                
                status.textContent = '✅ Canvas operations working correctly';
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '❌ Canvas error: ' + error.message;
                status.className = 'status error';
                console.error('Canvas test error:', error);
            }
        }

        // Test 4: Error Handling
        function testErrorHandling() {
            const status = document.getElementById('errorStatus');
            
            try {
                // Test with invalid parameters
                const qr = window.qrcode(1, 'L');
                qr.addData(''); // Empty data
                qr.make();
                
                status.textContent = '✅ Error handling working correctly';
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '✅ Error caught and handled: ' + error.message;
                status.className = 'status info';
            }
        }

        // Test 5: Performance
        function testPerformance() {
            const status = document.getElementById('performanceStatus');
            
            try {
                const startTime = performance.now();
                
                // Generate multiple QR codes
                for (let i = 0; i < 10; i++) {
                    const qr = window.qrcode(1, 'L');
                    qr.addData(`Performance test ${i}: ${Date.now()}`);
                    qr.make();
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                status.textContent = `✅ Performance test completed in ${duration.toFixed(2)}ms`;
                status.className = 'status success';
                
            } catch (error) {
                status.textContent = '❌ Performance test error: ' + error.message;
                status.className = 'status error';
                console.error('Performance test error:', error);
            }
        }

        // Test 6: Firefox-Specific Tests
        function testFirefoxSpecific() {
            const status = document.getElementById('firefoxStatus');
            const browserInfo = getBrowserInfo();
            
            try {
                let tests = [];
                
                // Test Firefox-specific features
                if (browserInfo.browser === 'Firefox') {
                    // Test if Firefox supports the features we need
                    tests.push('✅ Firefox detected');
                    
                    // Test canvas support
                    if (document.createElement('canvas').getContext) {
                        tests.push('✅ Canvas supported');
                    } else {
                        tests.push('❌ Canvas not supported');
                    }
                    
                    // Test performance API
                    if (window.performance && window.performance.now) {
                        tests.push('✅ Performance API supported');
                    } else {
                        tests.push('❌ Performance API not supported');
                    }
                    
                    // Test requestAnimationFrame
                    if (window.requestAnimationFrame) {
                        tests.push('✅ requestAnimationFrame supported');
                    } else {
                        tests.push('❌ requestAnimationFrame not supported');
                    }
                    
                    // Test JSON support
                    if (window.JSON && window.JSON.stringify) {
                        tests.push('✅ JSON supported');
                    } else {
                        tests.push('❌ JSON not supported');
                    }
                    
                } else {
                    tests.push(`ℹ️ Testing on ${browserInfo.browser} (Firefox-specific tests skipped)`);
                }
                
                status.innerHTML = tests.join('<br>');
                status.className = 'status info';
                
            } catch (error) {
                status.textContent = '❌ Firefox test error: ' + error.message;
                status.className = 'status error';
                console.error('Firefox test error:', error);
            }
        }

        // Auto-run tests on page load
        window.onload = function() {
            getBrowserInfo();
            setTimeout(() => {
                testQRLibrary();
                testCanvasCompatibility();
            }, 500);
        };
    </script>
</body>
</html>